<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Admin Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .recent-bookings {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .confirmed {
            background: #e6ffed;

            .confirm-button {
                background: #dc3545;
            }
        }

        .unconfirmed {
            /*yellowish*/
            background: #fff5df;
        }

        .confirm-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .confirm-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }


    </style>
</head>
<body>
<main class="main-content">
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Reservas Confirmadas</h3>
            <p id="active-bookings">--</p>
        </div>
        <div class="stat-card">
            <h3>Quartos Disponíveis</h3>
            <p>15/40</p>
        </div>
        <div class="stat-card">
            <h3>Serviços Ativos</h3>
            <p>8</p>
        </div>
        <div class="stat-card">
            <h3>Fotos Cadastradas</h3>
            <p>45</p>
        </div>
    </div>

    <div class="recent-bookings">
        <h2>Reservas Recentes</h2>
        <table>
            <thead>
            <tr>
                <th>Quarto</th>
                <th>Email</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>Confirmação</th>
            </tr>
            </thead>
            <tbody>
            <!-- dados adicionados via js-->
            </tbody>
        </table>
    </div>

    <div class="stat-card" style="margin-top: 20px;">
        <h3>Gráfico de Ocupação</h3>
        <!--        custom canvas-->
        <div style="height: 300px; background: #f0f0f0; border-radius: 8px;">
            <canvas id="occupation-graph" width="900" height="300"></canvas>
        </div>
    </div>
</main>

<script type="module">
    import db from '/js/db/index.js';

    db.users.checkUserLoggedIn();

    // Fetch recent bookings from the database
    const recentBookings = db.bookings.listAll();
    const rooms = db.rooms.listAll();
    const roomMap = new Map();
    rooms.forEach(room => {
        roomMap.set(room.id, room);
    });

    const render = () => {


        const tbody = document.querySelector("tbody");
        // drop all rows
        tbody.innerHTML = "";


        recentBookings.forEach(booking => {
            const room = roomMap.get(booking.roomId);

            const checkinDate = new Date(booking.checkIn).toLocaleDateString("pt-BR");
            const checkoutDate = new Date(booking.checkOut).toLocaleDateString("pt-BR");


            const tr = document.createElement("tr");

            const attributes = [room.name, booking.userEmail, checkinDate, checkoutDate];
            attributes.forEach(attr => {
                const td = document.createElement("td");
                td.textContent = attr;
                tr.appendChild(td);
            });

            const td = document.createElement("td");
            const confirmButton = document.createElement("button");
            confirmButton.classList.add("confirm-button");

            let confirmarReserva = () => {
                db.bookings.confirmBooking(booking.id);
                booking.confirmed = true;
                confirmButton.textContent = "Revogar";
                tr.classList.remove("unconfirmed");
                tr.classList.add("confirmed");
            };
            let revogarReserva = () => {
                booking.confirmed = false;
                db.bookings.revokeConfirmation(booking.id);
                confirmButton.textContent = "Confirmar";
                confirmButton.disabled = false;
                tr.classList.remove("confirmed");
                tr.classList.add("unconfirmed");
            };

            let toggleButton = () => {
                if (booking.confirmed) {
                    revogarReserva();
                } else {
                    confirmarReserva();
                }
                render();
            };


            td.appendChild(confirmButton);
            tr.appendChild(td);

            confirmButton.addEventListener("click", toggleButton);

            if (!booking.confirmed) {
                confirmButton.textContent = "Confirmar";
                tr.classList.add("unconfirmed");
            } else {
                confirmButton.textContent = "Revogar";
                tr.classList.add("confirmed");
            }
            tbody.appendChild(tr);


            const activeBookings = recentBookings.filter(booking => booking.confirmed).length;
            document.getElementById("active-bookings").textContent = `${activeBookings}`;


        });


        const canvas = document.getElementById("occupation-graph");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const bookingsPerDay = recentBookings
            .filter(booking => booking.confirmed)
            .reduce((acc, booking) => {
                const checkInDate = new Date(booking.checkIn).toLocaleDateString("pt-BR");
                if (acc[checkInDate]) {
                    acc[checkInDate]++;
                } else {
                    acc[checkInDate] = 1;
                }
                return acc;
            }, {});

        const initialDate = new Date();
        initialDate.setDate(initialDate.getDate() - 7);
        const today = new Date();


        while (initialDate <= today) {
            const bookings = bookingsPerDay[initialDate.toLocaleDateString("pt-BR")] || 0;
            ctx.fillStyle = "#007bff";
            ctx.fillRect(initialDate.getDay() * 100, 300 - bookings * 50, 50, bookings * 450);
            ctx.fillStyle = "black";
            // ctx.fillText(bookings, initialDate.getDay() * 100, 300 - bookings * 10 - 10);
            initialDate.setDate(initialDate.getDate() + 1);
        }


    };

    render();


</script>
</body>
</html>